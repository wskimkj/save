<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>공동 부부 가계부</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    input[type="number"] { width: 140px; }
    input[type="text"] { width: 160px; }
    select { padding: 6px; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button.primary { border-color: #333; }
    .muted { color: #666; font-size: 12px; }
    .tabs button { border: none; border-bottom: 2px solid transparent; border-radius: 0; padding: 10px 8px; }
    .tabs button.active { border-bottom-color: #333; font-weight: 600; }
    .hidden { display: none; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; color:#555; }
    pre { white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>공동 부부 가계부</h1>

  <div class="row">
    <label>월(month_key):
      <input id="monthKey" value="2025.08" placeholder="YYYY.MM" />
    </label>
    <span class="muted">예: 2025.08</span>

    <label>입력 대상(구분):
      <select id="owner">
        <option value="공통" selected>공통</option>
        <option value="돌프">돌프</option>
        <option value="천사">천사</option>
      </select>
    </label>
    <span class="pill">Monthly Edit는 선택한 대상에 저장</span>
  </div>

  <div class="tabs row" style="margin-top:12px">
    <button data-tab="dashboard" class="active">Dashboard</button>
    <button data-tab="monthly">Monthly Edit</button>
    <button data-tab="upload">Bulk Upload</button>
    <button data-tab="db">DB (All Data)</button>
  </div>

  <!-- Dashboard -->
  <section id="tab-dashboard" class="card">
    <h2>Dashboard</h2>
    <div class="row">
      <button id="btnRefresh" class="primary">DB에서 새로고침</button>
      <span id="status" class="muted"></span>
    </div>
    <div class="row" style="margin-top:12px">
      <div class="card" style="flex:1; min-width:220px">
        <div class="muted">총지출</div><div id="kpiSpend" style="font-size:24px">-</div>
      </div>
      <div class="card" style="flex:1; min-width:220px">
        <div class="muted">총저축</div><div id="kpiSave" style="font-size:24px">-</div>
      </div>
      <div class="card" style="flex:1; min-width:220px">
        <div class="muted">총수입</div><div id="kpiIncome" style="font-size:24px">-</div>
      </div>
    </div>
    <p class="muted">※ KPI/차트는 DB 읽기 API에 연결하면 자동 채워집니다. (month_key, owner 필터를 서버에서 적용)</p>
  </section>

  <!-- Monthly Edit -->
  <section id="tab-monthly" class="card hidden">
    <h2>Monthly Edit (기록 UI)</h2>
    <p class="muted">
      카테고리명은 기록 시트 항목명 그대로.
      값 수정 후 <b>“DB 반영(커밋)”</b>을 누르면 <b>선택한 월 + 입력 대상(구분)</b> 기준으로 DB를 교체합니다.
      (빈칸은 변경 없음)
    </p>

    <table id="catTable">
      <thead>
        <tr><th>Category</th><th>Amount</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="row" style="margin-top:12px">
      <button id="btnReload">DB에서 불러오기</button>
      <button id="btnCommit" class="primary">DB 반영(커밋)</button>
      <span id="monthlyMsg" class="muted"></span>
    </div>
  </section>

  <!-- Bulk Upload -->
  <section id="tab-upload" class="card hidden">
    <h2>Bulk Upload</h2>
    <p class="muted">
      템플릿(CSV)을 내려받아 작성 후 업로드하세요. 헤더는
      <b>month_key,owner,category,amount</b> 입니다.
    </p>

    <div class="row">
      <button id="btnDownloadTemplate">템플릿 다운로드(CSV)</button>
      <span class="muted">xlsx까지 하려면 브라우저 파서 라이브러리(예: SheetJS)가 필요해요.</span>
    </div>

    <div class="row" style="margin-top:12px">
      <input type="file" id="fileInput" accept=".csv" />
      <button id="btnPreview">미리보기</button>
      <button id="btnApplyUpload" class="primary">업로드 반영(월+구분 단위 교체)</button>
      <span id="uploadMsg" class="muted"></span>
    </div>

    <pre id="preview" style="background:#fafafa; padding:12px; border-radius:10px; overflow:auto; max-height:260px"></pre>
  </section>

  <!-- DB (All Data) -->
  <section id="tab-db" class="card hidden">
    <h2>DB (All Data)</h2>
    <p class="muted">DB 원장을 조회하고, 선택한 행을 수정한 뒤 저장하면 DB에 반영됩니다.</p>

    <div class="row">
      <label>month_key:
        <input id="dbMonthKey" placeholder="YYYY.MM" />
      </label>

      <label>owner:
        <select id="dbOwner">
          <option value="">(전체)</option>
          <option value="공통">공통</option>
          <option value="돌프">돌프</option>
          <option value="천사">천사</option>
        </select>
      </label>

      <label>source:
        <select id="dbSource">
          <option value="">(전체)</option>
          <option value="ui_monthly">ui_monthly</option>
          <option value="upload_monthly">upload_monthly</option>
        </select>
      </label>

      <button id="btnDbLoad" class="primary">불러오기</button>
      <span id="dbMsg" class="muted"></span>
    </div>

    <div style="overflow:auto; margin-top:12px">
      <table id="dbTable">
        <thead>
          <tr>
            <th>row_id</th><th>거래일자</th><th>구분</th>
            <th>지출</th><th>저축</th><th>수입</th>
            <th>상세항목</th><th>소분류</th><th>대분류</th>
            <th>source</th><th>month_key</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="dbEditor" class="card hidden">
      <h3>선택 행 수정</h3>
      <div class="row">
        <div class="muted">row_id: <span id="editRowId"></span></div>
      </div>
      <div class="row" style="margin-top:8px">
        <label>거래일자 <input id="editDate" type="text" placeholder="YYYY-MM-DD" /></label>
        <label>구분 <select id="editOwner">
          <option value="공통">공통</option><option value="돌프">돌프</option><option value="천사">천사</option>
        </select></label>
        <label>지출 <input id="editSpend" type="number" /></label>
        <label>저축 <input id="editSave" type="number" /></label>
        <label>수입 <input id="editIncome" type="number" /></label>
      </div>
      <div class="row" style="margin-top:8px">
        <label>상세항목 <input id="editDetail" type="text" style="width:280px" /></label>
        <label>source <input id="editSource" type="text" /></label>
        <label>month_key <input id="editMonthKey" type="text" /></label>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnDbSave" class="primary">저장(DB 반영)</button>
        <button id="btnDbCancel">취소</button>
        <span id="dbSaveMsg" class="muted"></span>
      </div>
    </div>
  </section>

<script>
  // ================== 설정 ==================
  // GitHub Pages(정적)에서 호출할 API 엔드포인트.
  // 예) Power Automate HTTP endpoint를 쓰면: API_BASE = "https://prod-xx....azure.com"
  // 이 예시는 API_BASE + "/commitMonthly" 같은 경로를 호출합니다.
  const API_BASE = ""; // TODO: 여기에 API base URL 설정

  // 기록 시트 카테고리(항목명) 그대로
  const CATEGORIES = [
    "식재료","외식","배달","중식","카페/간식",
    "쇼핑","미용","구독","생활편의",
    "여행","문화생활","운동",
    "보험","병원·약국","건강식품",
    "회비","경조/선물","친목","기부",
    "기타",
    "주거/통신","교통","공과금",
    "저축","투자","부채상환",
    "월급","기타수입","금융이자","주식매도"
  ];

  // ================== 탭 전환 ==================
  document.querySelectorAll(".tabs button").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      document.querySelectorAll("section[id^='tab-']").forEach(s => s.classList.add("hidden"));
      document.getElementById(`tab-${tab}`).classList.remove("hidden");
    });
  });

  // ================== Monthly table 렌더 ==================
  const tbody = document.querySelector("#catTable tbody");
  const state = {
    monthly: Object.fromEntries(CATEGORIES.map(c => [c, ""])),
  };

  function renderTable() {
    tbody.innerHTML = "";
    CATEGORIES.forEach(cat => {
      const tr = document.createElement("tr");
      const td1 = document.createElement("td"); td1.textContent = cat;
      const td2 = document.createElement("td");
      const inp = document.createElement("input");
      inp.type = "number";
      inp.placeholder = "금액";
      inp.value = state.monthly[cat] ?? "";
      inp.addEventListener("input", () => state.monthly[cat] = inp.value);
      td2.appendChild(inp);
      tr.append(td1, td2);
      tbody.appendChild(tr);
    });
  }
  renderTable();

  // ================== API helpers ==================
  async function postJson(path, payload) {
    if (!API_BASE) throw new Error("API_BASE가 비어있어요. (Power Automate/백엔드 URL 설정 필요)");
    const res = await fetch(API_BASE + path, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json().catch(() => ({}));
  }

  // ================== Dashboard 새로고침 ==================
  document.getElementById("btnRefresh").addEventListener("click", async () => {
    const month_key = document.getElementById("monthKey").value.trim();
    const owner = document.getElementById("owner").value;
    const status = document.getElementById("status");
    status.textContent = "불러오는 중...";
    try {
      const data = await postJson("/kpi", { month_key, owner });
      document.getElementById("kpiSpend").textContent = data.spend ?? "-";
      document.getElementById("kpiSave").textContent = data.save ?? "-";
      document.getElementById("kpiIncome").textContent = data.income ?? "-";
      status.textContent = "완료";
    } catch (e) {
      status.textContent = "실패: " + e.message;
    }
  });

  // ================== Monthly: DB에서 불러오기(리로드) ==================
  document.getElementById("btnReload").addEventListener("click", async () => {
    const month_key = document.getElementById("monthKey").value.trim();
    const owner = document.getElementById("owner").value;
    const msg = document.getElementById("monthlyMsg");
    msg.textContent = "불러오는 중...";
    try {
      const data = await postJson("/readMonthly", { month_key, owner });
      CATEGORIES.forEach(c => state.monthly[c] = "");
      (data.items || []).forEach(it => {
        if (it && it.category && CATEGORIES.includes(it.category)) {
          state.monthly[it.category] = (it.amount ?? "") + "";
        }
      });
      renderTable();
      msg.textContent = `DB 기준으로 갱신 완료 (${month_key} / ${owner})`;
    } catch (e) {
      msg.textContent = "실패: " + e.message;
    }
  });

  // ================== Monthly: DB 반영(커밋) ==================
  document.getElementById("btnCommit").addEventListener("click", async () => {
    const month_key = document.getElementById("monthKey").value.trim();
    const owner = document.getElementById("owner").value;
    const msg = document.getElementById("monthlyMsg");
    msg.textContent = "DB 반영 중...";
    try {
      const items = Object.entries(state.monthly)
        .filter(([_, v]) => v !== "" && v !== null && v !== undefined)
        .map(([category, v]) => ({ category, amount: Number(v) }));

      await postJson("/commitMonthly", {
        month_key,
        owner,
        source: "ui_monthly",
        items
      });
      msg.textContent = `DB 반영 완료 (${month_key} / ${owner})`;
    } catch (e) {
      msg.textContent = "실패: " + e.message;
    }
  });

  // ================== Bulk Upload: 템플릿 다운로드 ==================
  document.getElementById("btnDownloadTemplate").addEventListener("click", () => {
    const header = "month_key,owner,category,amount\n";
    const sample = [
      "2025.08,공통,식재료,320000",
      "2025.08,돌프,외식,180000",
      "2025.08,천사,카페/간식,90000"
    ].join("\n");
    const csv = header + sample + "\n";

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "monthly_upload_template.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // ================== Bulk Upload: CSV 파서 (month_key,owner,category,amount) ==================
  let uploadItems = [];

  function parseCsv(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
    if (lines.length < 2) throw new Error("CSV에 데이터가 없어요.");

    const headers = lines[0].split(",").map(s => s.trim());
    const idxMonth = headers.indexOf("month_key");
    const idxOwner = headers.indexOf("owner");
    const idxCat = headers.indexOf("category");
    const idxAmt = headers.indexOf("amount");
    if (idxMonth < 0 || idxOwner < 0 || idxCat < 0 || idxAmt < 0) {
      throw new Error("CSV 헤더는 month_key,owner,category,amount 여야 해요.");
    }

    return lines.slice(1).map((line, i) => {
      const cols = line.split(",").map(s => s.trim());
      const row = {
        month_key: cols[idxMonth],
        owner: cols[idxOwner],
        category: cols[idxCat],
        amount: Number(cols[idxAmt])
      };
      if (!row.month_key || !row.owner || !row.category || Number.isNaN(row.amount)) {
        throw new Error(`CSV ${i+2}행 형식이 이상해요: ${line}`);
      }
      return row;
    });
  }

  document.getElementById("btnPreview").addEventListener("click", async () => {
    const msg = document.getElementById("uploadMsg");
    msg.textContent = "";
    const f = document.getElementById("fileInput").files?.[0];
    if (!f) { msg.textContent = "CSV 파일을 선택해줘"; return; }
    const text = await f.text();
    try {
      uploadItems = parseCsv(text);
      document.getElementById("preview").textContent = JSON.stringify(uploadItems.slice(0, 200), null, 2);
      msg.textContent = `미리보기 OK (${uploadItems.length}행)`;
    } catch (e) {
      msg.textContent = "미리보기 실패: " + e.message;
    }
  });

  document.getElementById("btnApplyUpload").addEventListener("click", async () => {
    const msg = document.getElementById("uploadMsg");
    msg.textContent = "업로드 반영 중...";
    try {
      if (!uploadItems.length) throw new Error("먼저 미리보기를 해줘");

      // month_key + owner 단위로 커밋 (안전)
      const groups = {};
      uploadItems.forEach(r => {
        const k = `${r.month_key}__${r.owner}`;
        if (!groups[k]) groups[k] = { month_key: r.month_key, owner: r.owner, items: [] };
        groups[k].items.push({ category: r.category, amount: r.amount });
      });

      for (const k of Object.keys(groups)) {
        const g = groups[k];
        await postJson("/commitMonthly", {
          month_key: g.month_key,
          owner: g.owner,
          source: "upload_monthly",
          items: g.items
        });
      }

      msg.textContent = `업로드 반영 완료 (${Object.keys(groups).length}그룹)`;
    } catch (e) {
      msg.textContent = "실패: " + e.message;
    }
  });

  // ================== DB(All Data) ==================
  const dbTbody = document.querySelector("#dbTable tbody");
  let dbRows = [];
  let selectedRow = null;

  function setDbEditorVisible(visible) {
    document.getElementById("dbEditor").classList.toggle("hidden", !visible);
  }

  function renderDbTable(rows) {
    dbTbody.innerHTML = "";
    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.addEventListener("click", () => openEditor(r));

      const cells = [
        r.row_id ?? "",
        r.date ?? "",
        r.owner ?? "",
        r.spend ?? "",
        r.save ?? "",
        r.income ?? "",
        r.detail ?? "",
        r.subcat ?? "",
        r.cat ?? "",
        r.source ?? "",
        r.month_key ?? ""
      ];
      cells.forEach(v => {
        const td = document.createElement("td");
        td.textContent = String(v);
        tr.appendChild(td);
      });
      dbTbody.appendChild(tr);
    });
  }

  function openEditor(r) {
    selectedRow = r;
    setDbEditorVisible(true);
    document.getElementById("editRowId").textContent = r.row_id;

    document.getElementById("editDate").value = r.date ?? "";
    document.getElementById("editOwner").value = r.owner ?? "공통";
    document.getElementById("editSpend").value = r.spend ?? "";
    document.getElementById("editSave").value = r.save ?? "";
    document.getElementById("editIncome").value = r.income ?? "";
    document.getElementById("editDetail").value = r.detail ?? "";
    document.getElementById("editSource").value = r.source ?? "";
    document.getElementById("editMonthKey").value = r.month_key ?? "";
    document.getElementById("dbSaveMsg").textContent = "";
  }

  document.getElementById("btnDbCancel").addEventListener("click", () => {
    selectedRow = null;
    setDbEditorVisible(false);
  });

  document.getElementById("btnDbLoad").addEventListener("click", async () => {
    const msg = document.getElementById("dbMsg");
    msg.textContent = "불러오는 중...";

    const month_key = document.getElementById("dbMonthKey").value.trim();
    const owner = document.getElementById("dbOwner").value;
    const source = document.getElementById("dbSource").value;

    try {
      const data = await postJson("/readDb", { month_key, owner, source, limit: 300 });
      dbRows = data.rows || [];
      renderDbTable(dbRows);
      setDbEditorVisible(false);
      msg.textContent = `불러오기 완료 (${dbRows.length}건)`;
    } catch (e) {
      msg.textContent = "실패: " + e.message;
    }
  });

  document.getElementById("btnDbSave").addEventListener("click", async () => {
    if (!selectedRow) return;

    const saveMsg = document.getElementById("dbSaveMsg");
    saveMsg.textContent = "저장 중...";

    const row_id = selectedRow.row_id;

    const fields = {
      date: document.getElementById("editDate").value.trim(),
      owner: document.getElementById("editOwner").value,
      spend: Number(document.getElementById("editSpend").value || 0),
      save: Number(document.getElementById("editSave").value || 0),
      income: Number(document.getElementById("editIncome").value || 0),
      detail: document.getElementById("editDetail").value.trim(),
      source: document.getElementById("editSource").value.trim(),
      month_key: document.getElementById("editMonthKey").value.trim()
    };

    try {
      await postJson("/updateDb", { updates: [{ row_id, fields }] });

      Object.assign(selectedRow, fields);
      renderDbTable(dbRows);

      saveMsg.textContent = "저장 완료 (DB 반영됨)";
    } catch (e) {
      saveMsg.textContent = "실패: " + e.message;
    }
  });

  // 편의: 상단 month/owner를 DB 탭 필터에 복사해두기(처음 로드 때)
  document.getElementById("dbMonthKey").value = document.getElementById("monthKey").value;
  document.getElementById("dbOwner").value = document.getElementById("owner").value;
  document.getElementById("owner").addEventListener("change", () => {
    document.getElementById("dbOwner").value = document.getElementById("owner").value;
  });
  document.getElementById("monthKey").addEventListener("input", () => {
    document.getElementById("dbMonthKey").value = document.getElementById("monthKey").value;
  });
</script>
</body>
</html>

